<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        .avatar {
            border-radius: 50%;
        }
        .counterButton {
            display: block;
        }
    </style>
</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <c app></c>
</body>
<script>
    class Component {
        constructor(root, html) {
            console.assert(root);
            console.assert(html);
            const body = new DOMParser().parseFromString(html, 'text/html').body;
            if (body.children.length > 1)
                throw new Error(`More than one child in:\n${html}`);
            this.root = body.firstChild;
            for (const attr of this.root.attributes)
                this.root.setAttribute(attr.nodeName, attr.nodeValue);
            root.replaceWith(this.root);
            this.var = {};
            for (const varel of this.root.querySelectorAll('[var]')) {
                const varname = varel.getAttribute('var');
                if (this.var[varname])
                    console.error(`var name duplicate: '${varname}'`);
                else
                    this.var[varname] = varel;
            }
        }
    }

    class App extends Component {
        constructor(root, user) {
            if (!user) {
                super(root, '<div><h1>Log in...</h1> </div>');
                return;
            }
            console.assert(user.name);
            console.assert(user.imageUrl);
            console.assert(user.imageSize);
            super(root, `
                <div>
                    <h1>${user.name}</h1>
                    <img
                        class=avatar
                        src=${user.imageUrl}
                        alt=${'Photo of ' + user.name}
                        style=${`
                            width:  ${user.imageSize};
                            height: ${user.imageSize};
                        `}
                    >

                    <c var=shoppingList></c>

                    <c var=counter1></c>
                    <c var=counter2></c>
                    <c var=reset></c>
                </div>
            `);

            const products = [
              { title: 'Cabbage', isFruit: false, id: 1 },
              { title: 'Garlic',  isFruit: false, id: 2 },
              { title: 'Apple',   isFruit: true,  id: 3 },
            ];
            this.shoppingList = new ShoppingList(this.var.shoppingList, products);

            this.counter1 = new CounterButton(this.var.counter1);
            this.counter2 = new CounterButton(this.var.counter2);

            this.resetButton = new MyButton(this.var.reset, "reset", () => {
                this.counter1.setCounter(0);
                this.counter2.setCounter(0);
            });
        }
    };

    class ShoppingList extends Component {
        constructor(root, products) {
            super(root, `
                <ul>
                    ${products.map(p => `
                        <li style="color: ${(p.isFruit ? 'magenta' : 'darkgreen')}" >
                            ${p.title}
                        </li>
                    `).join('\n')}
                </ul>
            `);
        }
    }

    class MyButton extends Component {
        constructor(root, text, onClick) {
            super(root, `<button>${text}</button>`);
            this.root.addEventListener('click', () => {
                if (onClick) onClick()
                else this.handleClick();
            });
        }

        handleClick() {
            alert('You clicked me!');
        }
    }

    class CounterButton extends Component {
        constructor(root) {
            super(root, `<button class=counterButton></button>`);
            this.counter = 0;
            this.setCounter(this.counter);
            this.root.addEventListener('click', () => this.setCounter(++this.count));
        }

        setCounter(value) {
            this.count = value;
            this.root.innerText = `Clicked ${value} times`;
        }
    }

    const user = {
      name: 'Hedy Lamarr',
      imageUrl: 'https://i.imgur.com/yXOvdOSs.jpg',
      imageSize: 90,
    };

    const app = new App(document.querySelector('c[app]'), user);
</script>
